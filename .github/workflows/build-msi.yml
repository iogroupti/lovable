name: Build MSI Installer
# Auto-synced from Lovable

on:
  workflow_dispatch:
    inputs:
      client_id:
        description: 'Client ID (UUID)'
        required: true
        type: string
      client_name:
        description: 'Client Name (for filename)'
        required: true
        type: string
      api_key:
        description: 'Agent API Token'
        required: true
        type: string
      checkin_url:
        description: 'Agent check-in URL'
        required: true
        type: string
      realtime_url:
        description: 'WebSocket URL'
        required: true
        type: string
      anon_key:
        description: 'Supabase Anon Key'
        required: true
        type: string
      origin:
        description: 'Portal Origin URL'
        required: true
        type: string

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install msitools
        run: |
          sudo apt-get update
          sudo apt-get install -y msitools

      - name: Create WXS template
        run: |
          SAFE_CLIENT_NAME=$(echo "${{ inputs.client_name }}" | sed 's/[^a-zA-Z0-9]/_/g')
          PRODUCT_CODE=$(echo -n "${{ inputs.client_id }}" | md5sum | cut -c1-32 | sed 's/\(..\)/\1/g' | awk '{print toupper($0)}' | sed 's/^\(........\)\(....\)\(....\)\(....\)\(............\)$/{\1-\2-\3-\4-\5}/')
          UPGRADE_CODE="{12345678-1234-1234-1234-123456789ABC}"
          
          cat > /tmp/RMMAgent.wxs << 'WXSEOF'
          <?xml version='1.0' encoding='utf-8'?>
          <Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>
            <Product Id='PRODUCT_CODE_PLACEHOLDER' 
                     Name='IO RMM Agent - CLIENT_NAME_PLACEHOLDER' 
                     Language='1046' 
                     Version='3.1.0' 
                     Manufacturer='IO Group Tecnologia'
                     UpgradeCode='UPGRADE_CODE_PLACEHOLDER'>
              
              <Package InstallerVersion='500' Compressed='yes' InstallScope='perMachine' 
                       Description='Agente RMM IO Group para CLIENT_NAME_PLACEHOLDER'
                       Manufacturer='IO Group Tecnologia' />
              
              <MajorUpgrade DowngradeErrorMessage='Uma versão mais recente já está instalada.' />
              <MediaTemplate EmbedCab='yes' />
              
              <Feature Id='MainFeature' Title='RMM Agent' Level='1'>
                <ComponentGroupRef Id='ProductComponents' />
              </Feature>
              
              <Directory Id='TARGETDIR' Name='SourceDir'>
                <Directory Id='ProgramFilesFolder'>
                  <Directory Id='INSTALLFOLDER' Name='IORMMAgent'>
                    <Directory Id='ConfigFolder' Name='config' />
                    <Directory Id='LogsFolder' Name='logs' />
                  </Directory>
                </Directory>
              </Directory>
              
              <ComponentGroup Id='ProductComponents' Directory='INSTALLFOLDER'>
                <Component Id='InstallScript' Guid='*'>
                  <File Id='InstallPs1' Source='Install-IOAgent.ps1' KeyPath='yes' />
                </Component>
                <Component Id='AgentScript' Guid='*'>
                  <File Id='RMMAgentPs1' Source='RMMAgent.ps1' />
                </Component>
                <Component Id='ConfigFile' Guid='*' Directory='ConfigFolder'>
                  <File Id='AgentConfig' Source='agent-config.json' KeyPath='yes' />
                </Component>
              </ComponentGroup>
              
              <CustomAction Id='RunInstaller' 
                            Directory='INSTALLFOLDER'
                            ExeCommand='powershell.exe -ExecutionPolicy Bypass -File "[INSTALLFOLDER]Install-IOAgent.ps1" -Silent'
                            Execute='deferred'
                            Impersonate='no'
                            Return='check' />
              
              <InstallExecuteSequence>
                <Custom Action='RunInstaller' After='InstallFiles'>NOT Installed</Custom>
              </InstallExecuteSequence>
              
            </Product>
          </Wix>
          WXSEOF
          
          sed -i "s/PRODUCT_CODE_PLACEHOLDER/$PRODUCT_CODE/g" /tmp/RMMAgent.wxs
          sed -i "s/UPGRADE_CODE_PLACEHOLDER/$UPGRADE_CODE/g" /tmp/RMMAgent.wxs
          sed -i "s/CLIENT_NAME_PLACEHOLDER/$SAFE_CLIENT_NAME/g" /tmp/RMMAgent.wxs

      - name: Create agent config
        run: |
          cat > /tmp/agent-config.json << EOF
          {
            "ClientId": "${{ inputs.client_id }}",
            "Token": "${{ inputs.api_key }}",
            "CheckinUrl": "${{ inputs.checkin_url }}",
            "RealtimeUrl": "${{ inputs.realtime_url }}",
            "AnonKey": "${{ inputs.anon_key }}",
            "Origin": "${{ inputs.origin }}",
            "Version": "3.1.0",
            "InstalledAt": "",
            "RustDeskServer": "rustdesk.iogroup.com.br",
            "Features": {
              "Stive": true,
              "RustDesk": true,
              "Chocolatey": true,
              "WindowsUpdate": true,
              "Compliance": true
            }
          }
          EOF

      - name: Download agent scripts from Lovable Cloud
        run: |
          curl -sfL "${{ inputs.origin }}/agent/Install-IOAgent.ps1" -o /tmp/Install-IOAgent.ps1
          curl -sfL "${{ inputs.origin }}/agent/RMMAgent.ps1" -o /tmp/RMMAgent.ps1
          echo "Scripts downloaded from ${{ inputs.origin }}:"
          ls -la /tmp/*.ps1

      - name: Build MSI with wixl
        run: |
          cd /tmp
          SAFE_CLIENT_NAME=$(echo "${{ inputs.client_name }}" | sed 's/[^a-zA-Z0-9]/_/g')
          wixl -v RMMAgent.wxs -o "RMMAgentSetup_${SAFE_CLIENT_NAME}.msi"
          ls -la *.msi

      - name: Upload MSI to Supabase Storage
        run: |
          SAFE_CLIENT_NAME=$(echo "${{ inputs.client_name }}" | sed 's/[^a-zA-Z0-9]/_/g')
          MSI_FILE="/tmp/RMMAgentSetup_${SAFE_CLIENT_NAME}.msi"
          STORAGE_PATH="clients/${{ inputs.client_id }}/RMMAgentSetup_${SAFE_CLIENT_NAME}.msi"
          
          curl -X POST \
            "${SUPABASE_URL}/storage/v1/object/rmm-installers/${STORAGE_PATH}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/octet-stream" \
            -H "x-upsert: true" \
            --data-binary "@${MSI_FILE}"
          
          FILE_SIZE=$(stat -c%s "${MSI_FILE}")
          
          curl -X POST \
            "${SUPABASE_URL}/rest/v1/agent_installers" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "{
              \"client_id\": \"${{ inputs.client_id }}\",
              \"file_name\": \"RMMAgentSetup_${SAFE_CLIENT_NAME}.msi\",
              \"file_path\": \"${STORAGE_PATH}\",
              \"file_size\": ${FILE_SIZE},
              \"version\": \"3.1.0\"
            }"
          
          echo "✅ MSI uploaded successfully!"
          echo "Storage path: ${STORAGE_PATH}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: msi-installer
          path: /tmp/*.msi
          retention-days: 7
